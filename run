#!/bin/bash


DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"


# make sure its being run by root
id | grep "uid=0" > /dev/null
if [ "$?" != 0 ]
then
    echo "Please make sure you are running teahaz as root!"
    exit
fi

# make suer docker is installed
docker --version > /dev/null
if [ "$?" != 0 ]
then
    echo "Please make sure you have docker installed!"
    exit
fi

TEAHAZ_PORT=13337
if [ "$1" != "" ]
then
    case $1 in
        ''|*[!0-9]*) echo "Invalid port, using default!" ;;
        *) TEAHAZ_PORT=$1  ;;
    esac
fi



ID=""
function get_dID {
    running=$( docker ps)

    ID=$(echo $running | grep  -o ".............teahaz_server")

    ID=$(echo $ID | grep  -o "^............")

    if [ "$ID" == "" ]
    then
        ID=""
    fi

}


function git_pull {

    cd $DIR

    git pull
    if [ "$?" != 0 ]
    then
        echo "error while getting new updates"
        exit
    fi


}

function make_sure_cron_is_running {
    while [ 1 ]
    do
        if [ "$ID" == "" ]
        then
            get_dID
        else
            docker exec --user root $ID systemctl enable cron
            docker exec --user root $ID systemctl start cron

            if [ "$?" == 0 ]
            then
                exit
            fi
            sleep 6
        fi
    done
}


if [ "$1" == "kill" ]
then

    get_dID

    if [ "$ID" == "" ]
    then
        echo "no container running"

    else
        docker kill $ID

    fi



elif [ "$1" == "shell" ]
then

    get_dID

    if [ "$ID" == "" ]
    then
        echo "no container running"

    else
        docker exec -it $ID /bin/bash

    fi




elif [ "$1" == "rebuild" ]
then

    cd $DIR/docker

    docker build --no-cache -t teahaz_server:latest .


else

    get_dID

    if [ "$ID" == "" ]
    then
        cd $DIR/docker

        docker build --build-arg TEAHAZ_PORT=$TEAHAZ_PORT -t teahaz_server:latest .

        make_sure_cron_is_running &

        docker run -p $TEAHAZ_PORT:$TEAHAZ_PORT -e PYTHONUNBUFFERED=0 -e TEAHAZ_PORT=$TEAHAZ_PORT --rm -v $DIR:/home/teahaz teahaz_server:latest

    else
        echo "server is already running"
    fi

fi
